{% extends 'base.html' %}
{% load i18n %}
{% block header_button %}
  <a href="{% url 'cove:index' %}" class="btn btn-large btn-success">{% trans 'Load New File' %}</a>
{% endblock %}
{% block content %}

{% load cove_tags %}

{% trans 'Converted from Original' as converted %}
{% trans 'Original' as original %}
{% trans 'Excel Spreadsheet (.xlsx)' as xlsx %} 
{% trans 'CSV Spreadsheet (.csv)' as csv %} 
{% trans 'Excel Spreadsheet (.xlsx) with titles' as xlsx_titles %} 
{# Translators: JSON probably does not need a transalation: http://www.json.org/ #}
{% trans 'JSON' as JSON %}


{% block key_facts %}
{% endblock %}

{% block converted_files %}

<!--Download Converted Files-->
<div class="panel {% if conversion_error %}panel-danger{% elif conversion_warning_messages or conversion_warning_messages_titles %}panel-warning{% else %}panel-success{% endif %}">
  <div class="panel-heading">
    <h4 class="panel-title">
      <span class="glyphicon glyphicon-download" aria-hidden="true"></span>{% trans 'Download Files' %}
    </h4>
  </div>
      
  <div class="panel-body">
    {% if conversion == 'flatten' %}
      
      <ul class="list-unstyled left-space">
        <li>
          <a href="{{original_file.url}}">{{JSON}} ({{original}})</a> {{original_file.size|filesizeformat }}
        </li>
        {% if not conversion_error %}
          <li>
            <a href="{{converted_url}}.xlsx">{{xlsx}} ({{converted}})</a> {{converted_file_size|filesizeformat }}
          </li>
          <!--Only show for 360Giving files-->
          {% if request.cove_config.convert_titles %}
            <li>
              <a href="{{converted_url}}-titles.xlsx">{{xlsx_titles}} ({{converted}})</a> {{converted_file_size_titles|filesizeformat }}
            </li>
          {% endif %}
        {% endif %}
      </ul>
      {% if conversion_error %}
          <p>{% blocktrans %}The JSON could not be converted to Spreadsheet due to the error:{% endblocktrans %} {{ conversion_error }}</p>

          {% include 'error_extra.html' %}
      {% endif %}
    
    {% elif conversion == 'unflatten' %}
    
      <ul class="list-unstyled left-space">
        <li>
          <a href="{{original_file.url}}">
            {% if file_type == 'xlsx' %}
                {{xlsx}} ({{original}})
            {% elif file_type == 'csv' %}
                {{csv}} ({{original}})
            {% endif %}
            </a> 
            {{original_file.size|filesizeformat }}
          </li>
          <li>
            <a href="{{converted_url}}">{{JSON}} ({{converted}})</a> {{converted_file_size|filesizeformat }}
          </li>
      </ul>

    {% else %}
      <ul class="list-unstyled left-space">
        <li>
          <span class="pull-left"><a href="{{original_file.url}}">{{JSON}} ({{original}})</a> {{original_file.size|filesizeformat }}
          </span>
          {% if conversion == 'flattenable' %}
            <form method="post"> <button name="flatten" value="true" type="submit" class="btn btn-default btn-xs left-space"> {% blocktrans %}Convert to Spreadsheet{% endblocktrans %} </button> {% csrf_token %} </form>
          {% endif %}
        </li>
      </ul>
    {% endif %}

    
  </div>
</div>
{% endblock %}


{% if conversion_warning_messages %}
  <a name="conversion-warning" class="anchor"></a>
  <div class="panel panel-warning">
    <div class="panel-heading">
      <h4 class="panel-title">
        
        {% trans 'Conversion Warnings' %}
      </h4>
    </div>
    <div class="panel-body">
      {% if file_type == 'xlsx' or file_type == 'csv' %}
        <p class="explanation">In order to validate your data we need to convert it. During that conversion we found the following issues:</p>
      {% endif %}
      <ul>
        {% for warning_message in conversion_warning_messages %}
          <li>{{warning_message}}</li>
        {% endfor %}
      </ul>
    </div>
  </div>
{% endif %}


{% if conversion_warning_messages_titles %}
  <a name="conversion-warning" class="anchor"></a>
  <div class="panel panel-warning">
    <div class="panel-heading">
      <h4 class="panel-title">
        {% trans 'Conversion Warnings (titles)' %}
      </h4>
    </div>
    <div class="panel-body">
    {% if file_type == 'xlsx' or file_type == 'csv' %}
      <p class="explanation">In order to validate your data we need to convert it. During that conversion we found the following issues:</p>
    {% endif %}
    <ul>
      {% for warning_message in conversion_warning_messages_titles %}
        <li>{{warning_message}}</li>
      {% endfor %}
    </ul>
    </div>
  </div>
{% endif %}

{% if validation_errors %}
  {% for error, values in validation_errors %}
     {% cove_modal_errors className="validation-errors-"|concat:forloop.counter modalTitle=error|get_message errorList=values file_type=file_type %}
  {% endfor %}
  

  <a name="validation-errors" class="anchor"></a>
  <div class="panel panel-danger">
    <div class="panel-heading pointer" role="region" aria-expanded="true" aria-controls="validationTable" data-toggle="collapse" data-target="#validationTable">
      <h4 class="panel-title">
        {% trans 'Validation Errors' %}
      </h4>
    </div>
    <div id="validationTable" class="collapse in">
    <table class="table">
      <thead> 
        <tr> 
          <th>{% trans 'Error Description' %}</th> 
          <th>{% trans 'Error Count' %}</th> 
          <th>{% trans 'First 3 Examples' %}</th> 
          <th>{% trans 'Location of first 3 errors' %}</th> 
          {% if file_type == 'xlsx' or file_type == 'csv' %}
            <th>{% trans 'Spreadsheet Location of first 3 errors' %}</th> 
          {% endif %}
        </tr> 
      </thead>
      <tbody>
      {% for error, values in validation_errors %}
      <tr>
        {% if error|get_message_type in common_error_types %}
        <td><a href="{% url 'cove:common_errors' %}#{{error|get_message_type}}"> {{error|get_message}} </a></td>
        {% else %}
          <td>{{error|get_message}}</td> 
        {% endif %}
        <td>
          {% if values|length > 3 %}
            <a data-toggle="modal" data-target=".{{"validation-errors-"|concat:forloop.counter}}">
              {{values|length}}
            </a>
          {% else %}
              {{values|length}}
          {% endif %}
        </td>
        <td>
          <ul class="list-unstyled">
            {% for value in values|slice:":3" %}
              <li> {{value.value}} </li>
            {% endfor %}
          </ul>
        </td>
        <td>
          <ul class="list-unstyled">
            {% for value in values|slice:":3" %}
               <li> {{value.path}} </li>
            {% endfor %}
          </ul>
        </td>
        {% if file_type == 'xlsx' or file_type == 'csv' %}
        <td style="white-space: nowrap">
          <ul class="list-unstyled">
            {% for value in values|slice:":3" %}
            <li> <b>Sheet:</b> {{value.sheet}} <b>Row:</b> {{value.row_number}} {% if value.header %} <b>Header:</b> {{value.header}} {% endif %} </li>
            {% endfor %}
          </ul>
        </td>
        {% endif %}
      </tr>
      {% endfor %}
      </tbody>
    </table>
    </div>
  </div>
{% endif %}

{% if data_only %}
    <a name="additional-fields" class="anchor"></a>
    <div class="panel panel-warning">
      <div class="panel-heading pointer" role="region" aria-expanded="true" aria-controls="additionalFieldTable" data-toggle="collapse" data-target="#additionalFieldTable">
        <h4 class="panel-title">
          {% trans 'Additional Fields (fields in data not in schema)' %}
          {% if language_additional_field_warning %}
             <span class="indent"> {% trans 'Warning: fields with a language suffix will appear as additional field' %} </span>
          {% endif %}
        </h4>
      </div>
      <div id="additionalFieldTable" class="collapse in">
      <table class="table">
         <thead><tr> <th>{% trans 'Field' %}</th> <th>{% trans 'Path to Field' %}</th> <th>{% trans 'Usage Count' %}</th> </tr></thead>
         <tbody>
         {% for path, error, count in data_only %}
            <tr>
               <td>{{error}}</td> <td>{{path}}</td> <td>{{count}}</td>
            </tr>
         {% endfor %}
         </tbody>
      </table>
      </div>
    </div>
{% endif %}


{% block explore_content %}
{% endblock %}

{% block introduction %}
{% endblock %}

{% block howToUse %}
{% endblock %}

<div class="above-footer">
  <h2>{% trans "Save or Share these results" %}</h2>
  <p>{% blocktrans %}Use the following url to share these results:{% endblocktrans %}</p>
  <div class="copy-div">
      <span class="copy-span"> {{ current_url }} <span id="copy-url-button" title="Click to copy." data-clipboard-text={{ current_url }} class="btn copy-button glyphicon glyphicon-copy" aria-hidden="true"></span> </span>
  </div>
  {% comment %}Translators: Paragraph that describes the application{% endcomment %}
  <p>{% blocktrans %}These results will be available for 7 days from the day the data was first uploaded. You can revisit these results until then.{% endblocktrans %}</p>
  <p>{% blocktrans %}After 7 days all uploaded data is deleted from our servers, and the results will no longer be available. Anyone using the link to this page after that will be show a message that tells them the file has been removed.{% endblocktrans %}</p>
</div>
{% endblock %}

{% block extrafooterscript %}
  <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/zeroclipboard/2.2.0/ZeroClipboard.min.js"></script>
  <script type="text/javascript">
    $( document ).ready(function() {
        ZeroClipboard.config({swfPath: "http://cdnjs.cloudflare.com/ajax/libs/zeroclipboard/2.2.0/ZeroClipboard.swf"})
        var client = new ZeroClipboard( document.getElementById('copy-url-button') );
        rowCount = $('.result-table')[0].rows.length;
        if (rowCount < 10000) {
           $('.result-table').DataTable({
               "lengthMenu": [ [10, 25, 50, 100, -1], [10, 25, 50, 100, "All"] ]
           });
        }
    });
  </script>
  <script type="text/javascript" src="https://cdn.datatables.net/1.10.10/js/jquery.dataTables.min.js"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/1.10.10/js/dataTables.bootstrap.min.js"></script>
{% endblock %}

{% block extrapiwik %}
{% if piwik.dimension_map.file_type %}
_paq.push(['setCustomDimension', {{piwik.dimension_map.file_type}}, '{{file_type}}']);
{% endif %}
{% if piwik.dimension_map.page_type %}
_paq.push(['setCustomDimension', {{piwik.dimension_map.page_type}}, '{% if first_render %}explore initial{% else %}explore reload{% endif %}']);
{% endif %}
{% if first_render %}
{% if piwik.dimension_map.form_name %}
_paq.push(['setCustomDimension', {{piwik.dimension_map.form_name}}, '{{ form_name }}']);
{% endif %}
{% endif %}
{% endblock %}
